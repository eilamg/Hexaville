[gd_scene load_steps=7 format=2]

[ext_resource path="res://Tile/tile.tscn" type="PackedScene" id=1]
[ext_resource path="res://Camera/camera.tscn" type="PackedScene" id=2]
[ext_resource path="res://obj/building_farm.obj" type="ArrayMesh" id=3]
[ext_resource path="res://Tile/tiles.meshlib" type="MeshLibrary" id=4]

[sub_resource type="GDScript" id=1]
script/source = "extends Spatial


var Tile = preload(\"res://Tile/tile.tscn\")

onready var ghost_tile = $ghost_tile

var tile_weights = []
var tile_weights_ids = []


func _ready():
    randomize()
    read_tile_weights_file()


func _on_tile_anchor_clicked(glob_pos):
    var tile = Tile.instance()
    tile.global_transform.origin = glob_pos
    add_child(tile)

    tile.select_mesh(ghost_tile.selected_mesh)
    tile.set_orientation(ghost_tile.orientation)

    var i = select_random_tile()
    ghost_tile.select_mesh(i)

    tile.connect(\"anchor_clicked\", self, \"_on_tile_anchor_clicked\")
    tile.connect(\"anchor_moused_over\", ghost_tile, \"_on_tile_anchor_moused_over\")


func read_tile_weights_file():
    var file = File.new()

    var cumulative_weight = 0
    var _weights = []
    var _ids = []

    file.open(\"res://tile_weights.csv\", File.READ)

    var line = file.get_csv_line()
    line = file.get_csv_line()  # skip header line
    while len(line) > 1:
        cumulative_weight += int(line[2])
        _weights.append(cumulative_weight)
        _ids.append(line[0])
        line = file.get_csv_line()

    file.close()

    tile_weights = _weights
    tile_weights_ids = _ids


func select_random_tile():
    var i = randi() % tile_weights[-1]
    return tile_weights.bsearch(i)
"

[sub_resource type="GDScript" id=2]
script/source = "extends MeshInstance
tool


export(MeshLibrary) var mesh_library setget set_mesh_library
export(int) var selected_mesh setget select_mesh
export(int, 0, 5) var orientation setget set_orientation


func _ready():
    randomize()
    select_mesh(selected_mesh)
    set_orientation(orientation)


func set_mesh_library(value):
    mesh_library = value


func select_mesh(value):
    selected_mesh = value
    mesh = mesh_library.get_item_mesh(selected_mesh)


func set_orientation(value):
    orientation = value
    rotation_degrees = Vector3(0, 90 - 60 * orientation, 0)


func move_to_mouse(glob_pos):
    transform.origin = glob_pos


func _on_tile_anchor_moused_over(glob_pos):
    move_to_mouse(glob_pos)


func _input(event):
    if event is InputEventMouseButton and event.pressed:
        if event.button_index == 2 or event.button_index == 4:
            set_orientation((orientation + 1) % 6)
        elif event.button_index == 5:
            set_orientation((orientation - 1) % 6)
"

[node name="TilesScene" type="Spatial"]
script = SubResource( 1 )

[node name="tile" parent="." instance=ExtResource( 1 )]

[node name="camera" parent="." instance=ExtResource( 2 )]
transform = Transform( 0.961262, 0.194905, -0.194905, 0, 0.707107, 0.707107, 0.275637, -0.679715, 0.679715, -1.25, 4, 3.5 )
projection = 1
size = 5.5

[node name="ghost_tile" type="MeshInstance" parent="."]
transform = Transform( -4.37114e-08, 0, 1, 0, 1, 0, -1, 0, -4.37114e-08, -2.95681, 0, 1.53957 )
mesh = ExtResource( 3 )
material/0 = null
material/1 = null
material/2 = null
material/3 = null
material/4 = null
material/5 = null
script = SubResource( 2 )
mesh_library = ExtResource( 4 )
selected_mesh = 3
orientation = 0
[connection signal="anchor_clicked" from="tile" to="." method="_on_tile_anchor_clicked"]
[connection signal="anchor_moused_over" from="tile" to="ghost_tile" method="_on_tile_anchor_moused_over"]
